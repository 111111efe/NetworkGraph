"use strict";(function(){var t={nodes:[{id:0,label:"Person",size:30,properties:{role:"自然人股东",name:"刘德",image:"http://148.70.238.152/static/image/github.png"}},{id:1,label:"Company",size:10,properties:{registCapi:"5000.000",name:"有品信息科技有限公司",econKind:"有限责任公司(自然人投资或控股)",status:"存续"}},{id:2,label:"Company",properties:{name:"有品信息科技有限公司"}},{id:3,label:"Company",properties:{registCapi:"5000.000"}}],links:[{type:"EMPLOY",source:0,target:1,properties:{role:"董事"}},{type:"EMPLOY",source:1,target:2,properties:{role:"董事"}},{type:"EMPLOY",source:2,target:3,properties:{role:"董事"}},{type:"EMPLOY",source:0,target:2,properties:{role:"董事"}}]};var A={graph:{layout_mode:0,analyse_mode:false,gravitation:.3,repulsion:-800,calculate_state:true},node:{node_scale:1,node_size:25,node_color:"black",node_opacity:"1"},link:{link_scale:1,link_width:1,link_color:"#00FFFB",link_type:"slink"},show_status:{node_text:true,link_text:true}};var r=[];var n=[];var o=d3.forceSimulation().alpha(1).alphaDecay(.002).alphaMin(.002).force("r",null).force("link",d3.forceLink().strength(A.graph.gravitation)).force("charge",d3.forceManyBody().strength(A.graph.repulsion).distanceMax(400)).force("collision",d3.forceCollide(A.graph.node_size)).on("tick",e).on("end",function(){q()});var a={nodes:[],links:[]};function s(t){a=typeof t!=="undefined"?t:a;o.nodes(a.nodes).force("link").links(a.links);i(a);d(a)}function e(){r.attr("transform",function(t){return"translate("+t.x+","+t.y+")"});n.select(".link-path").attr("d",function(t){return L(t,A.link.link_type)});n.select("text").attr("dx",function(t){return P(t)}).attr("transform",function(t){return C(t)})}function i(t){r=d3.select("#node_layout").selectAll("g").data(t.nodes);r.exit().remove();var e=r.enter().append("g").attr("class","node").on("mousedown.select-node",u).on("mouseenter.enter-node",f).on("mouseleave.leave-node",v).on("dblclick",p).call(d3.drag().on("start",_).on("drag",M).on("end",b));e.append("circle").attr("class","foreground-circle").style("fill","#1e98ce").style("cursor","move").style("stroke-width","3px").style("stroke","#18769f");e.append("circle").attr("class","background-circle").style("cursor","move").style("stroke-opacity","0").style("stroke-width","16px").style("stroke","#68bdf6bf");r=r.merge(e);r.selectAll("circle").attr("r",function(t){if(!("size"in t)){t["size"]=A.node.node_size}return t.size*A.node.node_scale}).lower();l()}function l(){var e=arguments[0]?arguments[0]:"label";r.select("text").remove();r.filter(function(t){return typeof t.label!=="undefined"?true:false}).append("text").attr("x",function(t){return c(d3.select(this),t[e])}).attr("dy",".35em").style("display",A.show_status.node_text===true?"block":"none").style("pointer-events","none").style("fill","white").text(function(t){return t.label})}function c(t,e){var r=0;try{r=e.length}catch(t){console.log("Warning: nodes缺少name标签！");return}if(r<=4){t.append("tspan").attr("x",0).attr("y",2).text(e)}else{var n=e.substring(0,4);var a=e.substring(4,9);var o=e.substring(9,r);var s=-9;var i=2;var l=10;if(r<10){s+=5;i+=5}else{o=e.substring(9,11)+"..."}t.text("");t.append("tspan").attr("x",0).attr("y",s).text(function(){return n});t.append("tspan").attr("x",0).attr("y",i).text(function(){return a});t.append("tspan").attr("x",0).attr("y",l).text(function(){return o})}}function d(t){n=d3.select("#link_layout").selectAll("g").data(t.links);n.exit().remove();var e=n.enter().append("g").attr("class","link");e.append("path").attr("class","link-path").style("fill","none").style("cursor","pointer").style("stroke","#6f7071").style("stroke-width","4px");e.append("marker").attr("class","link-marker").attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -50 100 100").attr("refX",325).attr("refY",0).attr("markerWidth",12).attr("markerHeight",12).attr("orient","auto").append("path").attr("d","M20,0 L0,-30 L90,0 L0,30 L20,0").style("fill","#000000");e.append("text").attr("class","link-text").attr("dy",2).append("textPath").style("fill","#000000").style("display",A.show_status.link_text===true?"block":"none");n=n.merge(e);n.select("marker").attr("id",function(t){return"marker-"+t.index});n.select(".link-path").attr("id",function(t){return"link-"+t.index}).attr("marker-end",function(t){return"url(#marker-"+t.index+")"}).style("stroke-width",function(t){if(!("width"in t)){t["width"]=A.link.link_width}return t.width}).on("mousedown.select-link",g).on("mouseover.hover-link",k);n.select("textPath").text(function(t){return t.type}).attr("href",function(t){return"#link-"+t.index})}function u(t){q();t["selected"]=true;d3.select(this).classed("selected",true)}function p(e){var t=(e.size?e.size:A.node.size)+8;var r=t+30;var n=Math.cos(175/360*Math.PI);var a=Math.sin(175/360*Math.PI);var o=Math.cos(55/360*Math.PI);var s=Math.sin(55/360*Math.PI);var i=-(2*o+2*Math.sqrt(3)*s);var l=Math.pow(n,2)+3*Math.pow(a,2)+2*Math.sqrt(3)*n*a-3*Math.pow(r,2);var c=(Math.sqrt(Math.pow(i,2)-16*l)-i)/8;var d=Math.sqrt(Math.pow(r,2)-Math.pow(c,2));var u="M"+t*n+", -"+t*a+" "+"A"+t+", "+t+" 0 0, 1 "+t*o+", "+t*s+"L"+c+","+d+" "+"A"+r+", "+r+" 0 0, 0 "+t*n+", -"+r*a+"L"+t*n+",-"+t*a;d3.selectAll(".menu").remove();for(var p=0;p<3;p++){var f=d3.select(this).append("g").attr("class","menu");f.append("path").attr("class","menu-path").attr("id","menu-"+p).attr("d",u).attr("value",p).attr("transform","rotate("+p*120+" 0, 0)").style("fill","#bcbcbc").on("mouseenter",function(){d3.select(this).style("fill","#808080")}).on("mouseleave",function(){d3.select(this).style("fill","#bcbcbc")}).on("click",function(){var t=d3.select(this).attr("value");if(t==="0"){y(e)}else if(t==="1"){var r=d3.select("#temp_layout").append("line").attr("x1",e.x).attr("y1",e.y).style("stroke","#6f7071").style("stroke-width","2px").style("opacity","0");var n=document.getElementById("network_svg").getBoundingClientRect();d3.select("#network_svg").on("mousemove.add-link",function(){var t=E("#network_svg");var e=t.k;r.attr("x2",(d3.event.x-n.x-t.x)/e).attr("y2",(d3.event.y-n.y-t.y)/e);r.style("opacity",1)})}else if(t==="2"){h(e)}});f.append("rect").attr("class","menu-icon").attr("id","menu-icon-"+p).attr("width","20").attr("height","20").style("fill","url(#pattern-"+p+")").style("pointer-events","none")}d3.select("#menu-icon-0").attr("transform","translate(30, -30)");d3.select("#menu-icon-1").attr("transform","translate(-12.5, 35)");d3.select("#menu-icon-2").attr("transform","translate(-52.5, -30)")}function f(t){d3.select(this).select(".background-circle").style("stroke-opacity",.8)}function v(t){d3.select(this).select(".background-circle").style("stroke-opacity",0)}function y(t){}function h(e){a.nodes.splice(e.index,1);a.links=a.links.filter(function(t){return t.source!==e&&t.target!==e});r.filter(function(t){return t===e}).remove();n.filter(function(t){return t.source===e||t.target===e}).remove()}function g(){}function k(){}var m=false,x=[],w=[];function _(t){d3.event.sourceEvent.stopPropagation();q();x=r.filter(function(t){return t.selected});w=n.filter(function(e){var r=false;x.each(function(t){if(t.id===e.source.id||t.id===e.target.id){r=true}});return r})}function M(t){x.attr("transform",function(t){t.x+=d3.event.dx;t.y+=d3.event.dy;return"translate("+t.x+","+t.y+")"});w.select("path").attr("d",function(t){return L(t,A.link.link_type)});w.select("text").attr("dx",function(t){return P(t)}).attr("transform",function(t){return C(t)});if(m===false){z(r,x);z(n,w);m=true}}function b(t){d3.event.sourceEvent.stopPropagation();if(!d3.event.sourceEvent.ctrlKey){t.selected=false;d3.select(this).classed("selected",false)}r.style("opacity",1);n.style("opacity",1);m=false}function z(t,e){t.style("opacity",.3);e.style("opacity",1)}function L(t,e){if(t.source===t.target){var r=typeof t.source.size==="undefined"?A.node.node_size:t.source.size;var n=t.source.x+r*A.node.node_scale/4*3;var a=t.source.y+r*A.node.node_scale/4;var o=t.source.x+r*A.node.node_scale/4;var s=t.source.y+r*A.node.node_scale/4*3;var i=n+150;var l=a;var c=o;var d=s+150;return"M"+n+" "+a+"C"+i+" "+l+", "+c+" "+d+", "+o+" "+s}var u=null;var p=t.source.x;var f=t.source.y;var v=t.target.x;var y=t.target.y;var h=(v-p)/8;var g=(y-f)/8;var k=p+h;var m=f+g;var x=p+h*2;var w=f+g*2;var _=p+h*3;var M=f+g*3;var b=p+h*4;var z=f+g*4;var L=p+h*7;var P=f+g*6;if(e==="slink"){u="M"+p+","+f+" L"+v+","+y}else if(e==="clink"){u="M "+p+","+f+" C"+k+","+w+" "+x+","+M+" "+b+","+z+" S"+L+","+P+" "+v+","+y}else if(e==="hlink"){u="M "+p+","+f+" L"+b+","+f+" "+" L"+b+","+y+" L"+v+","+y}else if(e==="vlink"){u="M "+p+","+f+" L"+p+","+z+" "+" L"+v+","+z+" L"+v+","+y}return u}function P(t){var e=t.source.x;var r=t.source.y;var n=t.target.x;var a=t.target.y;var o=Math.sqrt(Math.pow(n-e,2)+Math.pow(a-r,2));return o/2}function C(t){var e=t.source.x;var r=t.source.y;var n=t.target.x;var a=t.target.y;return e<=n?"":"rotate(180, "+(e+n)/2+" "+(r+a)/2+")"}function E(t){var e=d3.select(t).attr("transform");var r=e&&/translate/.test(e)&&/scale/.test(e)&&e.match(/translate\(([^\)]+)\)\s?scale\(([^\)]+)/);var n=r&&r[1].split(",")||[0,0];var a=r&&r[2]||1;var o=e&&/rotate/.test(e)&&e.match(/\s?rotate\(([^\)]+)/);var s=o&&o[1]||0;var i=n[0];var l=n[1];return{x:i,y:l,k:a,rotate:s}}function B(){return t}function I(){A.graph.calculating=true;d3.select("#network-status").style("animation","calc ease 1s infinite");o.alpha(1).restart()}function q(){A.graph.calculating=false;d3.select("#network-status").style("animation","none");o.stop()}function O(t){A.graph.layout_mode=t}function Y(t){A.graph.analyse_mode=t}function D(t){var e=d3.select(typeof t!=="undefined"?t:"body").append("svg").attr("id","network_svg").style("width","100%").style("height","100%").on("click",function(){d3.selectAll(".menu").remove()});var r=e.append("g").attr("id","network_graph").style("user-select","none").style("font-size",7).style("text-anchor","middle");e.call(d3.zoom().scaleExtent([.1,10]).on("zoom",function(){r.attr("transform",d3.event.transform)})).on("dblclick.zoom",null);var n=document.getElementById("network_svg").getBoundingClientRect();o.force("center",d3.forceCenter(n.width/2,n.height/2));r.append("g").attr("id","temp_layout");r.append("g").attr("id","link_layout");r.append("g").attr("id","node_layout");var a=r.append("g").attr("id","defs_layout");a.append("pattern").attr("id","pattern-0").append("image").attr("xlink:href","https://www.easyicon.net/api/resizeApi.php?id=1202871&size=128");a.append("pattern").attr("id","pattern-1").append("image").attr("xlink:href","https://www.easyicon.net/api/resizeApi.php?id=1189598&size=128");a.append("pattern").attr("id","pattern-2").append("image").attr("xlink:href","https://www.easyicon.net/api/resizeApi.php?id=1158148&size=128");a.selectAll("pattern").attr("width","100%").attr("height","100%").select("image").attr("width",20).attr("height",20);return{getDemoData:B,startLayout:I,stopLayout:q,drawNetworkGraph:s,changeLayoutMode:O,changeAnalyseMode:Y}}window.NetworkGraph=D})();