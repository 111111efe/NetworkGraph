var create_x=0;var create_y=0;var node_menu=[[{text:"展开节点",func:function(){var e=Number($(this).attr("id"));var n=d3.select(this);var a=n.datum();if(a.border===true){alert("此节点为边界节点，无法展开。")}$.post("expand",JSON.stringify({node:{label:a.label,name:a.name}}),function(e,t){var e=JSON.parse(e);var l=false;e.nodes.forEach(function(t){var n=true;data.nodes.forEach(function(e){if(t.id===e.id){n=false}});if(n===true){data.nodes.push(t);l=true}});e.links.forEach(function(t){var n=true;data.links.forEach(function(e){if(t.source===e.source.id&&t.target===e.target.id){n=false}});if(n===true){data.links.push(t);l=true}});if(l===true){updateData(data)}else{a["border"]=true;n.append("text").attr("class","tip").attr("transform","translate(15, -15)").text("×")}})}},{text:"创建关系",func:function(){var n=d3.select(this).datum();var l=temp_layout.append("line").attr("stroke","#00FFFB").style("stroke-width",1).style("opacity","0").attr("x1",n.x).attr("y1",n.y).attr("marker-end","url(#resolved)");container.on("mousemove.add-link",function(){translate_scale_rotate=getTranslateAndScaleAndRotate("#network-graph");scale=translate_scale_rotate.k;l.attr("x2",(d3.event.x-translate_scale_rotate.x)/scale).attr("y2",(d3.event.y-translate_scale_rotate.y)/scale);l.style("opacity",1)});node_elements.selectAll("circle").classed("cursor-target",true).on("click.add-link",function(e){l.attr("x2",e.x).attr("y2",e.y);var t={source:n.id,target:e.id,label:"test"};data.links.push(t);updateData(data);l.remove();clearEvents()})}},{text:"删除节点",func:function(){removeNode(d3.select(this).datum());updateData(data)}},{text:"选中父节点",func:function(){selectNodes(0)}},{text:"选中子节点",func:function(){selectNodes(1)}},{text:"选中同级",func:function(){selectNodes(2)}},{text:"选中关联",func:function(){selectNodes(3)}}]];var link_menu=[[{text:"删除关系",func:function(){this.remove();data.links.splice(d3.select(this).datum().index,1);updateData(data)}}]];var create_menu=[[{text:"创建节点",func:function(){var e=d3.select("#attr-table").style("display","block");var t=e.select("tbody");t.selectAll("*").remove();t.append("tr").append("td").text("节点属性设置").attr("colspan",2).style("text-align","center");var n={};for(var l in data.nodes[0]){if(["x","y","vx","vy","index","selected","previouslySelected","color"].indexOf(l)>-1){continue}else{n[l]=null;var a=t.append("tr");if(l!="label"){a.append("td").text(l);a.append("td").append("input").attr("id",l)}else{a.append("td").text("label");var r=a.append("td").append("select").attr("id",l);support_labels.forEach(function(e){r.append("option").text(e)})}}}var o=t.append("tr").append("td").attr("colspan",2).append("div");o.append("button").text("确认").classed("attr-button",true).on("click",function(){clearEvents();e.style("display","none");for(l in n){n[l]=document.getElementById(l).value}create_node(n);clearEvents()});o.append("button").text("取消").classed("attr-button",true).on("click",function(){e.style("display","none")})}}]];var node_elements=null;var link_elements=null;var link_text_elements=null;var linkForce=d3.forceLink().id(function(e){return e.id}).strength(NETWORKCONFIG.link_strength);var simulation=d3.forceSimulation().force("link",linkForce).on("end",function(){stopLayout()});updateData(data);function updateData(e){setNetworkInfo(e);drawNetworkGraph(e);drawBarChart(e)}function setNetworkInfo(e){var t=d3.select("#network-info");t.selectAll(".info").remove();t.append("p").attr("class","info").text("节点数目："+e.nodes.length);t.append("p").attr("class","info").text("关系数目："+e.links.length)}function drawNetworkGraph(e){startLayout();if(NETWORKCONFIG.layout=="force"){linkForce.strength(NETWORKCONFIG.link_strength);simulation.alpha(1).alphaDecay(.002).alphaMin(.002).force("r",null).force("charge",d3.forceManyBody().strength(NETWORKCONFIG.node_charge).distanceMax(400)).force("center",d3.forceCenter((window.innerWidth-30)/2,(window.innerHeight-30)/2)).force("collision",d3.forceCollide(NETWORKCONFIG.node_size))}else{e.nodes.forEach(function(e){e.x=0;e.y=0});linkForce.strength(0);simulation.force("charge",d3.forceCollide().radius(NETWORKCONFIG.node_size*1.5)).force("r",d3.forceRadial(300,(window.innerWidth-30)/2,(window.innerHeight-30)/2)).alpha(5).alphaDecay(.1).alphaMin(.02)}link_elements=link_layout.selectAll("path").data(e.links);link_elements.exit().remove();link_elements=link_elements.enter().append("path").attr("class","link").merge(link_elements).attr("id",function(e,t){return"link-"+t}).on("mousedown.select-link",selectLink).on("mouseover.hover-link",hoverLink);link_text_elements=text_layout.selectAll("text").data(e.links);link_text_elements.exit().remove();link_text_elements=link_text_elements.enter().append("text").attr("class","link-text").style("font-size",10).merge(link_text_elements).style("display",SHOWCONFIG.link_text==true?"block":"none");link_text_elements.selectAll("textPath").remove();link_text_elements.append("textPath").attr("xlink:href",function(e,t){return"#link-"+t}).text(function(e){return e.label});node_elements=node_layout.selectAll(".node").data(e.nodes);node_elements.exit().remove();node_elements=node_elements.enter().append("g").attr("class","node").merge(node_elements).on("mousedown.select-node",selectNode).on("mouseover.hover-link",hoverNode).call(d3.drag().on("start",drag_start).on("drag",draging).on("end",drag_end));node_elements.selectAll("text").remove();node_elements.selectAll("circle").remove();node_elements.append("circle").attr("r",NETWORKCONFIG.node_size);node_elements.append("text").attr("class","node-text").attr("dy",".35em").attr("x",function(e){return textBreaking(d3.select(this),e.name)}).style("display",SHOWCONFIG.node_text===true?"block":"none");node_elements.filter(function(e){return e.border===true}).append("text").attr("class","tip").attr("transform","translate(15, -15)").text("x");fill_circle();simulation.nodes(e.nodes).on("tick",tick).force("link").links(e.links);simulation.restart();$(".node").smartMenu(node_menu,{name:"node_menu"});$(".link").smartMenu(link_menu,{name:"link_menu"})}$("#container").smartMenu(create_menu,{name:"create_menu"});function tick(){node_elements.attr("transform",function(e){return"translate("+e.x+","+e.y+")"});link_elements.attr("d",function(e){return genLinkPath(e,NETWORKCONFIG.line_style)}).attr("marker-end","url(#resolved)");link_text_elements.attr("dx",function(e){return getLineTextDx(e)})}d3.select("#layout-button").on("click",function(){NETWORKCONFIG.layout=NETWORKCONFIG.layout==="force"?"radius":"force";d3.select("#layout-switch").attr("class",NETWORKCONFIG.layout=="force"?"fa fa-toggle-off":"fa fa-toggle-on");drawNetworkGraph(data)});container.on("keydown",function(){if(d3.event.shiftKey===true){brush_svg.style("display","block")}}).on("keyup",function(){if(d3.event.shiftKey===true){brush_svg.style("display","none")}}).on("click",function(){if(d3.event.ctrlKey===false){d3.selectAll(".selected").classed("selected",false);d3.selectAll(".finded").classed("finded",false);node_elements.each(function(e){e.selected=false})}}).on("mousedown",function(){if(d3.event.which===3){create_x=d3.event.x;create_y=d3.event.y}});function clearEvents(){container.on("mousemove.add-link",null);node_elements.selectAll("circle").on("click.add-link",null).classed("cursor-target",false);temp_layout.selectAll("line").remove()}function create_node(e){var t=getTranslateAndScaleAndRotate("#network-graph");e.x=(create_x-t.x)/t.k;e.y=(create_y-t.y)/t.k;data.nodes.push(e);updateData(data)}function removeNode(t){data.nodes.splice(t.index,1);data.links=data.links.filter(function(e){if(e.source!==t&&e.target!==t){return true}});node_elements.filter(function(e){if(e===t){return true}}).remove();link_elements.filter(function(e){if(e.source===t||e.target===t){return true}}).remove();link_text_elements.filter(function(e){if(e.source===t||e.target===t){return true}}).remove()}d3.selectAll(".color-item").on("click",function(){markColor(d3.select(this).style("background-color"))});d3.select("#node-color").on("change",function(){markColor(this.value)});function markColor(t){var e=d3.selectAll(".selected");var n=d3.selectAll(".finded");e.each(function(e){e["color"]=t});n.each(function(e){e["color"]=t});fill_circle()}d3.select("#node-size").on("input propertychange",function(){NETWORKCONFIG.node_size=parseFloat(this.value);d3.select("marker").attr("refX",NETWORKCONFIG.node_size+7);node_elements.selectAll("circle").attr("r",NETWORKCONFIG.node_size);d3.selectAll("image").attr("width",NETWORKCONFIG.node_size*2).attr("height",NETWORKCONFIG.node_size*2)});d3.select("#node-opacity").on("input propertychange",function(){node_elements.select("circle").style("fill-opacity",this.value)});d3.select("#node-stroke").on("input propertychange",function(){node_elements.select("circle").style("stroke-width",this.value)});d3.select("#node-charge").on("input propertychange",function(){NETWORKCONFIG.node_charge=-this.value;simulation.force("charge",d3.forceManyBody().strength(NETWORKCONFIG.node_charge));startLayout()});d3.select("#link-strength").on("input propertychange",function(){NETWORKCONFIG.link_strength=parseFloat(this.value);simulation.force("link").strength(NETWORKCONFIG.link_strength);startLayout()});d3.select("#line-color").on("change",function(){d3.selectAll(".link").style("stroke",this.value);d3.select("marker").select("path").style("fill",this.value).style("stroke",this.value)});d3.select("#line-stroke-width").on("input propertychange",function(){link_elements.style("stroke-width",this.value)});d3.select("#line-style").on("change",function(){NETWORKCONFIG.line_style=this.value;tick()});function fill_circle(){if(NETWORKCONFIG.special===true){node_elements.select("circle").style("fill",function(e){return e.label!="undefined"&&support_labels.indexOf(e.label)>-1?"url(#"+e.label+")":"url(#default)"}).style("stroke",function(e){if("color"in e){return e.color}else{var t=support_labels.indexOf(e.label);e["color"]=color(t>-1?t:0);return e.color}})}else{node_elements.select("circle").style("fill",function(e){if("color"in e){return e.color}else{var t=support_labels.indexOf(e.label);e["color"]=color(t>-1?t:0);return e.color}}).style("stroke",function(e){return"white"})}}function drag_start(e){stopLayout();d3.event.sourceEvent.stopPropagation()}function draging(e){node_elements.filter(function(e){return e.selected}).each(function(e){e.x+=d3.event.dx;e.y+=d3.event.dy;d3.select(this).attr("transform","translate("+e.x+","+e.y+")")});link_elements.attr("d",function(e){return genLinkPath(e,NETWORKCONFIG.line_style)});link_text_elements.attr("dx",function(e){return getLineTextDx(e)})}function drag_end(e){if(!d3.event.sourceEvent.ctrlKey){e.selected=false;d3.select(this).classed("selected",false)}}d3.select("#stop-button").on("click",function(){NETWORKCONFIG.calculating===true?stopLayout():startLayout()});function startLayout(){NETWORKCONFIG.calculating=true;d3.select("#network-status").style("animation","calc ease 1s infinite");d3.select("#stop-button-text").text("停止布局");simulation.alpha(1).restart()}function stopLayout(){NETWORKCONFIG.calculating=false;d3.select("#network-status").style("animation","none");d3.select("#stop-button-text").text("重新布局");simulation.stop()}function hoverNode(e){var t=d3.select("#node-info");t.selectAll(".info").remove();var n=["x","y","vx","vy","index","selected","previouslySelected","color"];for(var l in e){if(n.indexOf(l.toString())!=-1){continue}t.append("p").attr("class","info").text(l+": "+e[l])}}function selectLink(e){e.selected=true;d3.select(this).classed("selected",true)}function hoverLink(e){var t=d3.select("#link-info");t.selectAll(".info").remove();var n=["x","y","vx","vy","index","selected","previouslySelected"];for(var l in e){var a=t.append("p").attr("class","info");if(l!="source"&&l!="target"){a.text(l+": "+e[l])}else{a.text(l+": "+e[l]["label"])}}}d3.select("#search-line").on("keypress",function(){if(d3.event.key==="Enter"){find_node_name()}});d3.select("#search-button").on("click",find_node_name);function find_node_name(t){var e=$("#search-line").val();var n=false;node_elements.each(function(e){if(e.name===t){d3.select(this).classed("finded",true);n=true}});if(n===false){alert("未查找到此节点")}}d3.select("#analyse-button").on("click",function(){NETWORKCONFIG.special=!NETWORKCONFIG.special;d3.select("#analyse-switch").attr("class",NETWORKCONFIG.special===true?"fa fa-toggle-on":"fa fa-toggle-off");fill_circle()});