var control={layout:"force",calculating:true,isBrush:false,node_text_state:true,link_text_state:false,marker_state:true,setting_state:false,screen_state:false,node_size:15,special:false,node_charge:-300,link_strength:.5,line_type:0};var create_x=null;var create_y=null;var width=window.innerWidth;var height=window.innerHeight;var svg=d3.select("#svg");var brush_svg=svg.append("g").attr("class","brush_svg").style("display","none");var stop_button=d3.select("#stop-button");var container=d3.select("#container");var defs_layout=container.append("defs");radial_gradient=defs_layout.append("radialGradient").attr("id","orange_red").attr("cx","50%").attr("cy","50%").attr("r","50%").attr("fx","50%").attr("fy","50%");radial_gradient.append("stop").attr("offset","0%").attr("stop-color","blue");radial_gradient.append("stop").attr("offset","50%").attr("stop-color","orange");radial_gradient.append("stop").attr("offset","100%").attr("stop-color","red");var temp_layout=container.append("g").attr("class","temp-layout");var link_layout=container.append("g").attr("class","link-layout");var text_layout=container.append("g").attr("class","text-layout");var node_layout=container.append("g").attr("class","node-layout");var marker=container.append("marker").attr("id","resolved").attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",control.node_size+7).attr("refY",0).attr("markerWidth",12).attr("markerHeight",12).attr("orient","auto").attr("stroke-width",2).append("path").attr("class","marker-path").attr("d","M2,0 L0,-3 L9,0 L0,3 M2,0 L0,3").attr("fill","green");var linkForce=d3.forceLink().id(function(t){return t.id}).strength(control.link_strength);var simulation=d3.forceSimulation().force("link",linkForce).on("end",function(){control.calculating=false;stop_button.text("重新布局")});restart(data);support_label.forEach(function(t){defs_layout.append("pattern").attr("id",t).attr("width","100%").attr("height","100%").append("image").attr("width",control.node_size*2).attr("height",control.node_size*2).attr("xlink:href","static/image/label/"+t+".jpg")});function restart(s){control.calculating=true;stop_button.text("停止布局");if(control.layout=="force"){linkForce.strength(control.link_strength);simulation.alpha(1).alphaDecay(.002).alphaMin(.002).force("r",null).force("charge",d3.forceManyBody().strength(control.node_charge).distanceMax(400)).force("center",d3.forceCenter((width-30)/2,(height-30)/2)).force("collision",d3.forceCollide(control.node_size))}else{s.nodes.forEach(function(t){t.x=0;t.y=0});linkForce.strength(0);simulation.force("charge",d3.forceCollide().radius(control.node_size*1.5)).force("r",d3.forceRadial(300,(width-30)/2,(height-30)/2)).alpha(5).alphaDecay(.1).alphaMin(.02)}simulation.nodes(s.nodes).on("tick",l).force("link").links(s.links);var r=link_layout.selectAll("path").data(s.links);r.exit().remove();r=r.enter().append("path").attr("class","link").merge(r).attr("id",function(t,e){return"link-"+e}).on("mousedown.select-link",selectLink).on("mouseover.hover-link",hoverLink);var n=text_layout.selectAll("text").data(s.links);n.exit().remove();n=n.enter().append("text").attr("class","link-text").style("font-size",10).merge(n).style("display",control.link_text_state==true?"block":"none");n.selectAll("textPath").remove();n.append("textPath").attr("xlink:href",function(t,e){return"#link-"+e}).text(function(t){return t.label});var a=node_layout.selectAll(".node").data(s.nodes);a.exit().remove();nodeElementsNew=a.enter().append("g").attr("class","node");nodeElementsNew.append("circle").attr("r",function(){return control.node_size});nodeElementsNew.append("text").attr("class","node_text").attr("font-size",5).attr("dy",".35em").attr("x",function(t){return textBreaking(d3.select(this),t.name)}).style("display",control.node_text_state==true?"block":"none");a=a.merge(nodeElementsNew).attr("fill",function(t){if(control.special==true){return t.label!="undefined"&&support_label.indexOf(t.label)>-1?"url(#"+t.label+")":"url(#default)"}else{return"black"}}).on("mousedown.select-node",x).on("mouseover.hover-link",hoverNode);a.call(d3.drag().on("start",t).on("drag",e).on("end",o));simulation.restart();function t(t){simulation.stop();d3.event.sourceEvent.stopPropagation()}function e(t){a.filter(function(t){return t.selected}).each(function(t){t.x+=d3.event.dx;t.y+=d3.event.dy;d3.select(this).attr("transform","translate("+t.x+","+t.y+")")});r.attr("d",function(t){return genLinkPath(t,control.line_type)});n.attr("dx",function(t){return getLineTextDx(t)})}function o(t){if(!d3.event.sourceEvent.ctrlKey){t.selected=false;d3.select(this).classed("selected",false)}}function l(){a.attr("transform",function(t){return"translate("+t.x+","+t.y+")"});r.attr("d",function(t){return genLinkPath(t,control.line_type)}).attr("marker-end","url(#resolved)");n.attr("dx",function(t){return getLineTextDx(t)})}svg.on("click",function(){if(!d3.event.ctrlKey){d3.selectAll(".selected").classed("selected",false);a.each(function(t){t.selected=false})}}).on("mousedown",function(){if(d3.event.which==3){create_x=d3.event.x;create_y=d3.event.y}});function c(t){var e=getTranslateAndScaleAndRotate();t.x=(create_x-e.x)/e.k;t.y=(create_y-e.y)/e.k;s.nodes.push(t);restart(s)}var i=[[{text:"展开节点",func:function(){var t=Number($(this).attr("id"));var e=d3.select(this).datum();$.post("expand",JSON.stringify({node:{label:e.label,name:e.name}}),function(t,e){t=JSON.parse(t);t.nodes.forEach(function(e){var n=true;s.nodes.forEach(function(t){if(e.id==t.id){n=false}});if(n){s.nodes.push(e)}});t.links.forEach(function(e){var n=true;s.nodes.forEach(function(t){if(e.id==t.id){n=false}});if(n){s.links.push(e)}});restart(s)})}},{text:"收起节点",func:function(){var t=Number($(this).attr("id"));var e=d3.select(this).datum()}},{text:"创建关系",func:function(){var n=d3.select(this).datum();var r=temp_layout.append("line").attr("stroke","#00FFFB").style("stroke-width",1).style("opacity","0").attr("x1",n.x).attr("y1",n.y);svg.on("mousemove.add-link",function(){translate_scale_rotate=getTranslateAndScaleAndRotate();scale=translate_scale_rotate.k;r.attr("x2",(d3.event.x-translate_scale_rotate.x)/scale).attr("y2",(d3.event.y-translate_scale_rotate.y)/scale);r.style("opacity",1)});a.selectAll("circle").classed("cursor-target",true).on("click.add-link",function(t){r.attr("x2",t.x).attr("y2",t.y);var e={source:n.id,target:t.id,label:"test"};s.links.push(e);restart(s);r.remove();p()})}},{text:"删除节点",func:function(){f(d3.select(this).datum());restart(s)}}]];var d=[[{text:"删除关系",func:function(){this.remove();s.links.splice(d3.select(this).datum().index,1);restart(s)}}]];var u=[[{text:"创建节点",func:function(){var t=d3.select("#attr-table").style("display","block");var e=t.select("tbody");e.selectAll("*").remove();e.append("tr").append("td").text("节点属性设置").attr("colspan",2).style("text-align","center");var n={};for(var r in s.nodes[0]){if(["x","y","vx","vy","index","selected","previouslySelected"].indexOf(r)>-1){continue}else{n[r]=null;var a=e.append("tr");if(r!="label"){a.append("td").text(r);a.append("td").append("input").attr("id",r)}else{a.append("td").text("label");var o=a.append("td").append("select").attr("id",r);support_label.forEach(function(t){o.append("option").text(t)})}}}var l=e.append("tr").append("td").attr("colspan",2).append("div");l.append("button").text("确认").classed("attr-button",true).on("click",function(){p();t.style("display","none");for(r in n){n[r]=document.getElementById(r).value}c(n);p()});l.append("button").text("取消").classed("attr-button",true).on("click",function(){t.style("display","none")})}}]];$(".node").smartMenu(i,{name:"node_menu"});$(".link").smartMenu(d,{name:"link_menu"});$("#svg").smartMenu(u,{name:"create_menu"});function f(e){s.nodes.splice(e.index,1);s.links=s.links.filter(function(t){if(t.source!==e&&t.target!==e){return true}});a.filter(function(t){if(t==e){return true}}).remove();r.filter(function(t){if(t.source==e||t.target==e){return true}}).remove();n.filter(function(t){if(t.source==e||t.target==e){return true}}).remove()}function p(){svg.on("mousemove.add-link",null);a.selectAll("circle").on("click.add-link",null).classed("cursor-target",false);temp_layout.selectAll("line").remove()}s.nodes.forEach(function(t){t.selected=false;t.previouslySelected=false});brushEvent=d3.brush().extent([[0,0],[width,height]]).on("start",v).on("brush",h).on("end",g);brush_svg.call(brushEvent);function v(){if(d3.event.sourceEvent.type!=="end"){a.classed("selected",false);s.nodes.forEach(function(t){t.selected=false})}}function h(){if(d3.event.sourceEvent.type!=="end"){var e=d3.event.selection;a.classed("selected",function(t){return t.selected=t.previouslySelected^(e!=null&&e[0][0]<=t.x&&t.x<e[1][0]&&e[0][1]<=t.y&&t.y<e[1][1])})}}function g(){if(d3.event.selection!=null){d3.select(this).call(d3.event.target.move,null)}}d3.selectAll(".color-item").on("click",function(){var t=a.filter(function(t){return t.selected}).select("circle");if(control.special==true){t.style("stroke",d3.select(this).style("background-color"))}else{t.style("fill",d3.select(this).style("background-color"))}});d3.select("#node-color").on("change",function(){var t=a.filter(function(t){return t.selected});if(control.special==true){t.style("stroke",this.value)}else{t.style("fill",this.value)}});d3.select("#select-correlation").on("click",function(){y(0)});d3.select("#select-same-degree").on("click",function(){y(1)});d3.select("#select-childs").on("click",function(){y(2)});d3.select("#select-parents").on("click",function(){y(3)});function y(n){var r=s.nodes.filter(function(t,e){return t.selected});var a=[];if(n==1){s.links.forEach(function(t,e){if(r.indexOf(t.target)>-1){t.source.selected=false;a.push(t.source)}})}s.links.forEach(function(t,e){if(r.indexOf(t.source)>-1&&n==0){t.target.selected=true}else if(r.indexOf(t.target)>-1&&n==0){t.source.selected=true}else if(a.indexOf(t.source)>-1&&n==1){t.target.selected=true}else if(r.indexOf(t.source)>-1&&n==2){t.target.selected=true}else if(r.indexOf(t.target)>-1&&n==3){t.source.selected=true}});k()}function k(){a.each(function(t){if(t.selected==true){d3.select(this).classed("selected",true)}})}d3.select("#straight-line").on("click",function(){control.line_type=0;l()});d3.select("#bezier-curves").on("click",function(){control.line_type=1;l()});d3.select("#horizontal-broken-line").on("click",function(){control.line_type=2;l()});d3.select("#vertical-broken-line").on("click",function(){control.line_type=3;l()});d3.select("#node-size").on("input propertychange",function(){control.node_size=parseFloat(this.value);d3.select("marker").attr("refX",control.node_size+7);a.selectAll("circle").attr("r",control.node_size);d3.selectAll("image").attr("width",control.node_size*2).attr("height",control.node_size*2);simulation.force("collision",d3.forceCollide(control.node_size)).alpha(0).restart()});d3.select("#node-opacity").on("input propertychange",function(){var n=this.value;a.style("opacity",function(t,e){return n})});d3.select("#node-stroke").on("input propertychange",function(){var n=this.value;a.selectAll("circle").style("stroke-width",function(t,e){return n})});d3.select("#node-charge").on("input propertychange",function(){control.node_charge=-this.value;simulation.force("charge",d3.forceManyBody().strength(control.node_charge));simulation.alpha(1).restart()});d3.select("#link-strength").on("input propertychange",function(){control.link_strength=parseFloat(this.value);simulation.force("link").strength(control.link_strength);simulation.alpha(1).restart()});d3.select("#line-color").on("change",function(){d3.selectAll("path").style("stroke",this.value)});d3.select("#line-stroke-width").on("input propertychange",function(){var n=this.value;r.style("stroke-width",function(t,e){return n})});d3.select("#analyse-button").on("click",function(){control.special=!control.special;d3.select("#analyse-switch").attr("class",control.special==true?"fa fa-toggle-on":"fa fa-toggle-off");a.select("circle").style("fill",function(t){if(control.special==true){return t.label!="undefined"&&support_label.indexOf(t.label)>-1?"url(#"+t.label+")":"url(#default)"}else{return"black"}})});function x(t){d3.select(this).classed("find-node",false);if(d3.event.which==3){simulation.stop()}t.selected=true;d3.select(this).classed("selected",true)}d3.select("#layout-button").on("click",function(){control.layout=control.layout=="force"?"radius":"force";d3.select("#layout-switch").attr("class",control.layout=="radius"?"fa fa-toggle-on":"fa fa-toggle-off");restart(s)});d3.select("#download-data").on("click",m);function m(){var t=JSON.parse(JSON.stringify(s));t.nodes.forEach(function(t){delete t.index;delete t.x;delete t.y;delete t.vx;delete t.vy;delete t.selected;delete t.previouslySelected});t.links.forEach(function(t){delete t.index;t.source=t.source.id;t.target=t.target.id});var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+JSON.stringify(t,null,4));e.setAttribute("download","data.json");e.style.display="none";document.body.appendChild(e);e.click();document.body.removeChild(e)}}d3.select("#upload-button").on("click",function(){var t=new FormData;var e=$("#file-input")[0].files[0];t.append("file",e);$.ajax({url:"upload",type:"POST",data:t,processData:false,contentType:false,success:function(t){restart(JSON.parse(t));d3.select("#upload-layout").style("display","none");d3.select("#file-name").text(this.value);d3.select("file-state").text("等待上传")},error:function(){alert("数据上传失败！")}})});stop_button.on("click",function(){if(control.calculating==true){simulation.stop();stop_button.text("重新布局");control.calculating=false}else{control.calculating=true;stop_button.text("停止布局");simulation.restart()}});d3.select("#rotate").on("click",function(){var t=getTranslateAndScaleAndRotate();t.rotate=parseInt(t.rotate)+10+"";zoomFunction(t)});d3.select("#rerotate").on("click",function(){var t=getTranslateAndScaleAndRotate();t.rotate=parseInt(t.rotate)-10+"";zoomFunction(t)});var zoom=d3.zoom().on("zoom",function(){var t=getTranslateAndScaleAndRotate();d3.event.transform["rotate"]=t.rotate;zoomFunction(d3.event.transform)});svg.call(zoom).on("dblclick.zoom",null);function zoomFunction(t){container.attr("transform","translate("+t.x+","+t.y+") "+"scale("+t.k+") "+"rotate("+t.rotate+")");brush_svg.attr("transform","translate("+t.x+","+t.y+") "+"scale("+t.k+") "+"rotate("+t.rotate+")");brush_svg.select("rect").attr("x",-t.x/t.k).attr("y",-t.y/t.k).attr("width",width/t.k).attr("height",height/t.k)}d3.select("#zoom-out").on("click",function(){var t=getTranslateAndScaleAndRotate();t.k=parseFloat(t.k)*1.5+"";zoomFunction(t)});d3.select("#zoom-in").on("click",function(){var t=getTranslateAndScaleAndRotate();t.k=parseFloat(t.k)/1.5+"";zoomFunction(t)});d3.select("#zoom-reset").on("click",function(){var t=getTranslateAndScaleAndRotate();t.k="1";zoomFunction(t)});d3.select("#brush-mode").on("click",function(){d3.select(this).classed("high-light",control.isBrush=!control.isBrush);brush_svg.style("display",control.isBrush==true?"block":"none")});d3.select("#node-button").on("click",function(){control.node_text_state=!control.node_text_state;d3.select("#node-switch").attr("class",control.node_text_state==true?"fa fa-toggle-on":"fa fa-toggle-off");d3.selectAll(".node text").style("display",control.node_text_state==true?"block":"none")});d3.select("#link-button").on("click",function(){control.link_text_state=!control.link_text_state;d3.select("#link-switch").attr("class",control.link_text_state==true?"fa fa-toggle-on":"fa fa-toggle-off");text_layout.selectAll("text").style("display",control.link_text_state==true?"block":"none")});d3.select("#marker-button").on("click",function(){control.marker_state=!control.marker_state;d3.select("#marker-switch").attr("class",control.marker_state==true?"fa fa-toggle-on":"fa fa-toggle-off");d3.selectAll(".marker-path").style("display",control.marker_state==true?"block":"none")});d3.selectAll("#setting-button").on("click",function(){control.setting_state=!control.setting_state;d3.select("#setting-box").style("display",control.setting_state==true?"block":"none")});d3.select("#screen-button").on("click",function(){control.screen_state=!control.screen_state;d3.select("#screen-switch").attr("class",control.screen_state==true?"fa fa-compress":"fa fa-expand");control.screen_state==true?enterFullScreen():exitFullScreen()});function textBreaking(t,e){var n=e.length;if(n<=4){t.append("tspan").attr("x",0).attr("y",2).text(e)}else{var r=e.substring(0,4);var a=e.substring(4,9);var o=e.substring(9,n);var l=-9;var s=2;var c=10;if(n<=10){l+=5;s+=5}else{o=e.substring(9,11)+"..."}t.text("");t.append("tspan").attr("x",0).attr("y",l).text(function(){return r});t.append("tspan").attr("x",0).attr("y",s).text(function(){return a});t.append("tspan").attr("x",0).attr("y",c).text(function(){return o})}}function genLinkPath(t,e){var n=null;var r=0;var a=t.source.x;var o=t.source.y;var l=t.target.x;var s=t.target.y;var c=(l-a)/8;var i=(s-o)/8;var d=a+c;var u=o+i;var f=a+c*2;var p=o+i*2;var v=a+c*3;var h=o+i*3;var g=a+c*4;var y=o+i*4;var k=a+c*7;var x=o+i*6;if(e==0){n="M"+a+","+o+" L"+l+","+s}else if(e==1){n="M "+a+","+o+" C"+d+","+p+" "+f+","+h+" "+g+","+y+" S"+k+","+x+" "+l+","+s}else if(e==2){n="M "+a+","+o+" L"+g+","+o+" "+" L"+g+","+s+" L"+l+","+s}else if(e==3){n="M "+a+","+o+" L"+a+","+y+" "+" L"+l+","+y+" L"+l+","+s}return n}function getLineTextDx(t){var e=t.source.x;var n=t.source.y;var r=t.target.x;var a=t.target.y;var o=Math.sqrt(Math.pow(r-e,2)+Math.pow(a-n,2));var l=t.label.length;var s=(o-3*l)/2;return s}function hoverNode(t){var e=d3.select("#node-info").style("display","block");e.selectAll(".info").remove();for(var n in t){if(["x","y","vx","vy","index","selected","previouslySelected"].indexOf(n.toString())!=-1){continue}e.append("p").attr("class","info").text(n+": "+t[n])}}function hoverLink(t){var e=d3.select("#link-info").style("display","block");e.selectAll(".info").remove();for(var n in t){var r=e.append("p").attr("class","info");if(n!="source"&&n!="target"){r.text(n+": "+t[n])}else{r.text(n+": "+t[n]["label"])}}}function selectLink(t){t.selected=true;d3.select(this).classed("selected",true)}function getTranslateAndScaleAndRotate(){var t=container.attr("transform");var e=t&&/translate/.test(t)&&/scale/.test(t)&&t.match(/translate\(([^\)]+)\)\s?scale\(([^\)]+)/);var n=e&&e[1].split(",")||[0,0];var r=e&&e[2]||1;var a=t&&/rotate/.test(t)&&t.match(/\s?rotate\(([^\)]+)/);var o=a&&a[1]||0;var l=n[0];var s=n[1];return{x:l,y:s,k:r,rotate:o}}