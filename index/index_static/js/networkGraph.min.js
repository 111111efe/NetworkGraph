var network_config={layout:"force",calculating:true,isBrush:false,node_text_state:true,link_text_state:false,marker_state:true,setting_state:false,screen_state:false,bar_state:false,node_size:15,special:false,node_charge:-300,link_strength:.5,line_type:0};var create_x=0;var create_y=0;var svg=d3.select("#svg");var brush_svg=svg.append("g").attr("class","brush_svg").style("display","none");var stop_button=d3.select("#stop-button");var container=d3.select("#container");var defs_layout=container.append("defs");radial_gradient=defs_layout.append("radialGradient").attr("id","orange_red").attr("cx","50%").attr("cy","50%").attr("r","50%").attr("fx","50%").attr("fy","50%");radial_gradient.append("stop").attr("offset","0%").attr("stop-color","blue");radial_gradient.append("stop").attr("offset","50%").attr("stop-color","orange");radial_gradient.append("stop").attr("offset","100%").attr("stop-color","red");var temp_layout=container.append("g").attr("class","temp-layout");var link_layout=container.append("g").attr("class","link-layout");var text_layout=container.append("g").attr("class","text-layout");var node_layout=container.append("g").attr("class","node-layout");var marker=container.append("marker").attr("id","resolved").attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",network_config.node_size+7).attr("refY",0).attr("markerWidth",12).attr("markerHeight",12).attr("orient","auto").attr("stroke-width",2).append("path").attr("class","marker-path").attr("d","M2,0 L0,-3 L9,0 L0,3 M2,0 L0,3").attr("fill","green");var linkForce=d3.forceLink().id(function(e){return e.id}).strength(network_config.link_strength);var simulation=d3.forceSimulation().force("link",linkForce).on("end",function(){stop_layout()});restart(data);support_labels.forEach(function(e){defs_layout.append("pattern").attr("id",e).attr("width","100%").attr("height","100%").append("image").attr("width",network_config.node_size*2).attr("height",network_config.node_size*2).attr("xlink:href","static/image/label/"+e+".jpg")});function restart(s){start_layout();drawBarChart(s);if(network_config.layout=="force"){linkForce.strength(network_config.link_strength);simulation.alpha(1).alphaDecay(.002).alphaMin(.002).force("r",null).force("charge",d3.forceManyBody().strength(network_config.node_charge).distanceMax(400)).force("center",d3.forceCenter((width-30)/2,(height-30)/2)).force("collision",d3.forceCollide(network_config.node_size))}else{s.nodes.forEach(function(e){e.x=0;e.y=0});linkForce.strength(0);simulation.force("charge",d3.forceCollide().radius(network_config.node_size*1.5)).force("r",d3.forceRadial(300,(width-30)/2,(height-30)/2)).alpha(5).alphaDecay(.1).alphaMin(.02)}simulation.nodes(s.nodes).on("tick",l).force("link").links(s.links);var n=link_layout.selectAll("path").data(s.links);n.exit().remove();n=n.enter().append("path").attr("class","link").merge(n).attr("id",function(e,t){return"link-"+t}).on("mousedown.select-link",selectLink).on("mouseover.hover-link",hoverLink);var r=text_layout.selectAll("text").data(s.links);r.exit().remove();r=r.enter().append("text").attr("class","link-text").style("font-size",10).merge(r).style("display",network_config.link_text_state==true?"block":"none");r.selectAll("textPath").remove();r.append("textPath").attr("xlink:href",function(e,t){return"#link-"+t}).text(function(e){return e.label});var a=node_layout.selectAll(".node").data(s.nodes);a.exit().remove();a=a.enter().append("g").attr("class","node").merge(a).on("mousedown.select-node",x).on("mouseover.hover-link",hoverNode).call(d3.drag().on("start",e).on("drag",t).on("end",o));a.selectAll("text").remove();a.selectAll("circle").remove();a.append("circle").attr("r",network_config.node_size);a.append("text").attr("class","node_text").attr("font-size",5).attr("dy",".35em").attr("x",function(e){return textBreaking(d3.select(this),e.name)}).style("display",network_config.node_text_state===true?"block":"none");if(network_config.special===true){y("pic")}simulation.restart();function e(e){stop_layout();d3.event.sourceEvent.stopPropagation()}function t(e){a.filter(function(e){return e.selected}).each(function(e){e.x+=d3.event.dx;e.y+=d3.event.dy;d3.select(this).attr("transform","translate("+e.x+","+e.y+")")});n.attr("d",function(e){return genLinkPath(e,network_config.line_type)});r.attr("dx",function(e){return getLineTextDx(e)})}function o(e){if(!d3.event.sourceEvent.ctrlKey){e.selected=false;d3.select(this).classed("selected",false)}}function l(){a.attr("transform",function(e){return"translate("+e.x+","+e.y+")"});n.attr("d",function(e){return genLinkPath(e,network_config.line_type)}).attr("marker-end","url(#resolved)");r.attr("dx",function(e){return getLineTextDx(e)})}svg.on("click",function(){if(!d3.event.ctrlKey){d3.selectAll(".selected").classed("selected",false);d3.selectAll(".finded").classed("finded",false);a.each(function(e){e.selected=false})}}).on("mousedown",function(){if(d3.event.which==3){create_x=d3.event.x;create_y=d3.event.y}});function c(e){var t=getTranslateAndScaleAndRotate();e.x=(create_x-t.x)/t.k;e.y=(create_y-t.y)/t.k;s.nodes.push(e);restart(s)}var i=[[{text:"展开节点",func:function(){var e=Number($(this).attr("id"));var t=d3.select(this).datum();$.post("expand",JSON.stringify({node:{label:t.label,name:t.name}}),function(e,t){var e=JSON.parse(e);var r=false;e.nodes.forEach(function(t){var n=true;s.nodes.forEach(function(e){if(t.id===e.id){n=false}});if(n===true){s.nodes.push(t);r=true}});e.links.forEach(function(t){var n=true;s.links.forEach(function(e){if(t.source===e.source.id&&t.target===e.target.id){n=false}});if(n===true){s.links.push(t);r=true}});if(r===true){restart(s)}else{alert("该节点为边界节点，请更换节点进行展开。")}})}},{text:"收起节点",func:function(){var e=Number($(this).attr("id"));var t=d3.select(this).datum()}},{text:"创建关系",func:function(){var n=d3.select(this).datum();var r=temp_layout.append("line").attr("stroke","#00FFFB").style("stroke-width",1).style("opacity","0").attr("x1",n.x).attr("y1",n.y);svg.on("mousemove.add-link",function(){translate_scale_rotate=getTranslateAndScaleAndRotate();scale=translate_scale_rotate.k;r.attr("x2",(d3.event.x-translate_scale_rotate.x)/scale).attr("y2",(d3.event.y-translate_scale_rotate.y)/scale);r.style("opacity",1)});a.selectAll("circle").classed("cursor-target",true).on("click.add-link",function(e){r.attr("x2",e.x).attr("y2",e.y);var t={source:n.id,target:e.id,label:"test"};s.links.push(t);restart(s);r.remove();p()})}},{text:"删除节点",func:function(){f(d3.select(this).datum());restart(s)}}]];var d=[[{text:"删除关系",func:function(){this.remove();s.links.splice(d3.select(this).datum().index,1);restart(s)}}]];var u=[[{text:"创建节点",func:function(){var e=d3.select("#attr-table").style("display","block");var t=e.select("tbody");t.selectAll("*").remove();t.append("tr").append("td").text("节点属性设置").attr("colspan",2).style("text-align","center");var n={};for(var r in s.nodes[0]){if(["x","y","vx","vy","index","selected","previouslySelected"].indexOf(r)>-1){continue}else{n[r]=null;var a=t.append("tr");if(r!="label"){a.append("td").text(r);a.append("td").append("input").attr("id",r)}else{a.append("td").text("label");var o=a.append("td").append("select").attr("id",r);support_labels.forEach(function(e){o.append("option").text(e)})}}}var l=t.append("tr").append("td").attr("colspan",2).append("div");l.append("button").text("确认").classed("attr-button",true).on("click",function(){p();e.style("display","none");for(r in n){n[r]=document.getElementById(r).value}c(n);p()});l.append("button").text("取消").classed("attr-button",true).on("click",function(){e.style("display","none")})}}]];$(".node").smartMenu(i,{name:"node_menu"});$(".link").smartMenu(d,{name:"link_menu"});$("#svg").smartMenu(u,{name:"create_menu"});function f(t){s.nodes.splice(t.index,1);s.links=s.links.filter(function(e){if(e.source!==t&&e.target!==t){return true}});a.filter(function(e){if(e==t){return true}}).remove();n.filter(function(e){if(e.source==t||e.target==t){return true}}).remove();r.filter(function(e){if(e.source==t||e.target==t){return true}}).remove()}function p(){svg.on("mousemove.add-link",null);a.selectAll("circle").on("click.add-link",null).classed("cursor-target",false);temp_layout.selectAll("line").remove()}s.nodes.forEach(function(e){e.selected=false;e.previouslySelected=false});brushEvent=d3.brush().extent([[0,0],[width,height]]).on("start",g).on("brush",k).on("end",v);brush_svg.call(brushEvent);function g(){if(d3.event.sourceEvent.type!=="end"){a.classed("selected",false);s.nodes.forEach(function(e){e.selected=false})}}function k(){if(d3.event.sourceEvent.type!=="end"){var t=d3.event.selection;a.classed("selected",function(e){return e.selected=e.previouslySelected^(t!=null&&t[0][0]<=e.x&&e.x<t[1][0]&&t[0][1]<=e.y&&e.y<t[1][1])})}}function v(){if(d3.event.selection!=null){d3.select(this).call(d3.event.target.move,null)}}d3.selectAll(".color-item").on("click",function(){var e=d3.selectAll(".selected").select("circle");var t=d3.selectAll(".finded").select("circle");if(network_config.special===true){e.style("stroke",d3.select(this).style("background-color"));t.style("stroke",d3.select(this).style("background-color"))}else{e.style("fill",d3.select(this).style("background-color"));t.style("fill",d3.select(this).style("background-color"))}});d3.select("#node-color").on("change",function(){var e=a.filter(function(e){return e.selected});if(network_config.special==true){e.style("stroke",this.value)}else{e.style("fill",this.value)}});d3.select("#select-correlation").on("click",function(){_(0)});d3.select("#select-same-degree").on("click",function(){_(1)});d3.select("#select-childs").on("click",function(){_(2)});d3.select("#select-parents").on("click",function(){_(3)});function _(n){var r=s.nodes.filter(function(e,t){return e.selected});var a=[];if(n==1){s.links.forEach(function(e,t){if(r.indexOf(e.target)>-1){e.source.selected=false;a.push(e.source)}})}s.links.forEach(function(e,t){if(r.indexOf(e.source)>-1&&n==0){e.target.selected=true}else if(r.indexOf(e.target)>-1&&n==0){e.source.selected=true}else if(a.indexOf(e.source)>-1&&n==1){e.target.selected=true}else if(r.indexOf(e.source)>-1&&n==2){e.target.selected=true}else if(r.indexOf(e.target)>-1&&n==3){e.source.selected=true}});h()}function h(){a.each(function(e){if(e.selected==true){d3.select(this).classed("selected",true)}})}d3.select("#straight-line").on("click",function(){network_config.line_type=0;l()});d3.select("#bezier-curves").on("click",function(){network_config.line_type=1;l()});d3.select("#horizontal-broken-line").on("click",function(){network_config.line_type=2;l()});d3.select("#vertical-broken-line").on("click",function(){network_config.line_type=3;l()});d3.select("#node-size").on("input propertychange",function(){network_config.node_size=parseFloat(this.value);d3.select("marker").attr("refX",network_config.node_size+7);a.selectAll("circle").attr("r",network_config.node_size);d3.selectAll("image").attr("width",network_config.node_size*2).attr("height",network_config.node_size*2);simulation.force("collision",d3.forceCollide(network_config.node_size)).alpha(0).restart()});d3.select("#node-opacity").on("input propertychange",function(){a.select("circle").style("fill-opacity",this.value)});d3.select("#node-stroke").on("input propertychange",function(){a.select("circle").style("stroke-width",this.value)});d3.select("#node-charge").on("input propertychange",function(){network_config.node_charge=-this.value;simulation.force("charge",d3.forceManyBody().strength(network_config.node_charge));simulation.alpha(1).restart()});d3.select("#link-strength").on("input propertychange",function(){network_config.link_strength=parseFloat(this.value);simulation.force("link").strength(network_config.link_strength);simulation.alpha(1).restart()});d3.select("#line-color").on("change",function(){d3.selectAll("path").style("stroke",this.value)});d3.select("#line-stroke-width").on("input propertychange",function(){n.style("stroke-width",this.value)});d3.select("#analyse-button").on("click",function(){network_config.special=!network_config.special;d3.select("#analyse-switch").attr("class",network_config.special==true?"fa fa-toggle-on":"fa fa-toggle-off");if(network_config.special===true){y("pic")}else{y()}});function y(t){if(t==="pic"){a.select("circle").style("fill",function(e){return e.label!="undefined"&&support_labels.indexOf(e.label)>-1?"url(#"+e.label+")":"url(#default)"})}else{a.select("circle").style("fill",function(e){return t})}}function x(e){d3.select(this).classed("finded",false);if(d3.event.which==3){stop_layout()}e.selected=true;d3.select(this).classed("selected",true)}d3.select("#layout-button").on("click",function(){network_config.layout=network_config.layout==="force"?"radius":"force";d3.select("#layout-switch").attr("class",network_config.layout=="force"?"fa fa-toggle-off":"fa fa-toggle-on");restart(s)});d3.select("#download-data").on("click",m);function m(){var e=JSON.parse(JSON.stringify(s));e.nodes.forEach(function(e){delete e.index;delete e.x;delete e.y;delete e.vx;delete e.vy;delete e.selected;delete e.previouslySelected});e.links.forEach(function(e){delete e.index;e.source=e.source.id;e.target=e.target.id});var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+JSON.stringify(e,null,4));t.setAttribute("download","data.json");t.style.display="none";document.body.appendChild(t);t.click();document.body.removeChild(t)}}d3.select("#upload-button").on("click",function(){var e=new FormData;var t=$("#file-input")[0].files[0];e.append("file",t);$.ajax({url:"upload",type:"POST",data:e,processData:false,contentType:false,success:function(e){restart(JSON.parse(e));d3.select("#upload-layout").style("display","none");d3.select("#file-name").text(this.value);d3.select("file-state").text("等待上传")},error:function(){alert("数据上传失败！")}})});stop_button.on("click",function(){network_config.calculating==true?stop_layout():start_layout()});function stop_layout(){network_config.calculating=false;stop_button.text("重新布局");simulation.stop()}function start_layout(){network_config.calculating=true;stop_button.text("停止布局");simulation.restart()}d3.select("#rotate").on("click",function(){var e=getTranslateAndScaleAndRotate();e.rotate=parseInt(e.rotate)+10+"";zoomFunction(e)});d3.select("#rerotate").on("click",function(){var e=getTranslateAndScaleAndRotate();e.rotate=parseInt(e.rotate)-10+"";zoomFunction(e)});var zoom=d3.zoom().on("zoom",function(){var e=getTranslateAndScaleAndRotate();d3.event.transform["rotate"]=e.rotate;zoomFunction(d3.event.transform)});svg.call(zoom).on("dblclick.zoom",null);function zoomFunction(e){container.attr("transform","translate("+e.x+","+e.y+") "+"scale("+e.k+") "+"rotate("+e.rotate+")");brush_svg.attr("transform","translate("+e.x+","+e.y+") "+"scale("+e.k+") "+"rotate("+e.rotate+")");brush_svg.select("rect").attr("x",-e.x/e.k).attr("y",-e.y/e.k).attr("width",width/e.k).attr("height",height/e.k)}d3.select("#zoom-out").on("click",function(){var e=getTranslateAndScaleAndRotate();e.k=parseFloat(e.k)*1.5+"";zoomFunction(e)});d3.select("#zoom-in").on("click",function(){var e=getTranslateAndScaleAndRotate();e.k=parseFloat(e.k)/1.5+"";zoomFunction(e)});d3.select("#zoom-reset").on("click",function(){var e=getTranslateAndScaleAndRotate();e.k="1";zoomFunction(e)});d3.select("#brush-mode").on("click",function(){d3.select(this).classed("high-light",network_config.isBrush=!network_config.isBrush);brush_svg.style("display",network_config.isBrush===true?"block":"none")});d3.select("#bar-graph").on("click",function(){d3.select(this).classed("high-light",network_config.bar_state=!network_config.bar_state);d3.select("#bargraph").style("display",network_config.bar_state===true?"block":"none")});d3.select("#node-button").on("click",function(){network_config.node_text_state=!network_config.node_text_state;d3.select("#node-switch").attr("class",network_config.node_text_state===true?"fa fa-toggle-on":"fa fa-toggle-off");d3.selectAll(".node text").style("display",network_config.node_text_state===true?"block":"none")});d3.select("#link-button").on("click",function(){network_config.link_text_state=!network_config.link_text_state;d3.select("#link-switch").attr("class",network_config.link_text_state===true?"fa fa-toggle-on":"fa fa-toggle-off");text_layout.selectAll("text").style("display",network_config.link_text_state===true?"block":"none")});d3.select("#marker-button").on("click",function(){network_config.marker_state=!network_config.marker_state;d3.select("#marker-switch").attr("class",network_config.marker_state===true?"fa fa-toggle-on":"fa fa-toggle-off");d3.selectAll(".marker-path").style("display",network_config.marker_state===true?"block":"none")});d3.selectAll("#setting-button").on("click",function(){network_config.setting_state=!network_config.setting_state;d3.select("#setting-box").style("display",network_config.setting_state===true?"block":"none")});d3.select("#screen-button").on("click",function(){network_config.screen_state=!network_config.screen_state;d3.select("#screen-switch").attr("class",network_config.screen_state===true?"fa fa-compress":"fa fa-expand");network_config.screen_state==true?enterFullScreen():exitFullScreen()});function textBreaking(e,t){var n=0;try{n=t.length}catch(e){return}if(n<=4){e.append("tspan").attr("x",0).attr("y",2).text(t)}else{var r=t.substring(0,4);var a=t.substring(4,9);var o=t.substring(9,n);var l=-9;var s=2;var c=10;if(n<=10){l+=5;s+=5}else{o=t.substring(9,11)+"..."}e.text("");e.append("tspan").attr("x",0).attr("y",l).text(function(){return r});e.append("tspan").attr("x",0).attr("y",s).text(function(){return a});e.append("tspan").attr("x",0).attr("y",c).text(function(){return o})}}function genLinkPath(e,t){var n=null;var r=0;var a=e.source.x;var o=e.source.y;var l=e.target.x;var s=e.target.y;var c=(l-a)/8;var i=(s-o)/8;var d=a+c;var u=o+i;var f=a+c*2;var p=o+i*2;var g=a+c*3;var k=o+i*3;var v=a+c*4;var _=o+i*4;var h=a+c*7;var y=o+i*6;if(t==0){n="M"+a+","+o+" L"+l+","+s}else if(t==1){n="M "+a+","+o+" C"+d+","+p+" "+f+","+k+" "+v+","+_+" S"+h+","+y+" "+l+","+s}else if(t==2){n="M "+a+","+o+" L"+v+","+o+" "+" L"+v+","+s+" L"+l+","+s}else if(t==3){n="M "+a+","+o+" L"+a+","+_+" "+" L"+l+","+_+" L"+l+","+s}return n}function getLineTextDx(e){var t=e.source.x;var n=e.source.y;var r=e.target.x;var a=e.target.y;var o=Math.sqrt(Math.pow(r-t,2)+Math.pow(a-n,2));var l=e.label.length;var s=(o-3*l)/2;return s}function hoverNode(e){var t=d3.select("#node-info").style("display","block");t.selectAll(".info").remove();for(var n in e){if(["x","y","vx","vy","index","selected","previouslySelected"].indexOf(n.toString())!=-1){continue}t.append("p").attr("class","info").text(n+": "+e[n])}}function hoverLink(e){var t=d3.select("#link-info").style("display","block");t.selectAll(".info").remove();for(var n in e){var r=t.append("p").attr("class","info");if(n!="source"&&n!="target"){r.text(n+": "+e[n])}else{r.text(n+": "+e[n]["label"])}}}function selectLink(e){e.selected=true;d3.select(this).classed("selected",true)}function getTranslateAndScaleAndRotate(){var e=container.attr("transform");var t=e&&/translate/.test(e)&&/scale/.test(e)&&e.match(/translate\(([^\)]+)\)\s?scale\(([^\)]+)/);var n=t&&t[1].split(",")||[0,0];var r=t&&t[2]||1;var a=e&&/rotate/.test(e)&&e.match(/\s?rotate\(([^\)]+)/);var o=a&&a[1]||0;var l=n[0];var s=n[1];return{x:l,y:s,k:r,rotate:o}}